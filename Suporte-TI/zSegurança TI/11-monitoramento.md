# Espiando a rede

Para monitorar o tipo de tráfego da sua rede, você precisa de um mecanismo para capturar pacotes de tráfego de rede para análise e possível registro em log. A detecção ou captura de pacotes é o processo de interceptação total de pacotes da rede para análise. É uma ferramenta inestimável para especialistas em suporte de TI na resolução de problemas. Existem muitas ferramentas que facilitam bastante essa ação.

Por padrão, interfaces de rede a pilha do software de rede de um sistema operacional se comportam como uma interface bem recatada: Só aceitam e processam pacotes encaminhados com endereços de interface específicos normalmente identificados por um endereço MAC. Se um pacote com um endereço de destino diferente é encontrado, a interface simplesmente o descarta.

Mas, se quiséssemos capturar todos os pacotes que uma interface consegue ver, como quando monitoramos todo o tráfego de rede em um segmento da rede, esse comportamento seria um problema para nós. Para anulá-lo, podemos colocar a interface no que chamamos de "modo promíscuo". Esse é um modo especial para interfaces de rede Ethernet que basicamente diz o seguinte: _"Hoje eu quero tomar todos (os pacotes)."_ Em vez de aceitar e gerenciar somente os pacotes que têm seu endereço como destino, ela passa a aceitar e processar tudo que chegar. Isso é muito melhor para análise ou monitoramento de rede. Também vale dizer que é preciso ter privilégios de administrador ou grupo para colocar uma interface no modo promíscuo e começar a capturar pacotes.

Outra ponto importante a considerar ao executar capturas de pacote e ter acesso ao tráfego que você gostaria de capturar e monitorar. Digamos que você quisesse analisar todo o tráfego entre hosts conectados a um switch e que sua máquina também está conectada a uma porta desse switch.

O espelhamento de portas permite ao switch espelhar todos os pacotes de uma porta específica, de uma faixa de portas ou da VLAN inteira e direcioná-los a outra porta do switch. Com isso, você ganhe acesso a todos os pacotes que passam pelo switch de uma forma mais simples e segura. Há outra forma útil, mas menos avançada, de se obter acesso a pacotes em um ambiente de rede que usa switches. Você pode inserir um hub na topologia com o dispositivo ou dispositivos cujo tráfego você gostaria de monitorar conectado ao hub e à máquina de monitoramento.

Os hubs são uma forma rápida e não ortodoxa de espelhar pacotes para a interface de captura. E, logicamente, eles têm algumas desvantagens, como a menor taxa de transferência e o potencial de introdução de colisões. Para capturar pacotes de uma rede sem fio, o processo é um pouco diferente.

O modo promíscuo aplicado a um dispositivo sem fio permitiria que o cliente sem fio processasse e recebesse pacotes destinados a outros clientes da rede à qual ele está associado. Mas se quiséssemos capturar e analisar todo o tráfego sem fio que pudermos receber na área imediata, podemos configurar nossa interface sem fio em um modo chamado "modo monitor". O modo monitor permite verificar canais para ver todo o tráfego sem fio que está sendo enviado por APs e clientes. Não importa a rede de destino do tráfego e não é preciso que o dispositivo-cliente esteja associado ou conectado a uma rede sem fio. Para capturar o tráfego sem fio, você só precisa de uma interface em modo monitor. Assim como para ativar o modo promíscuo, você ativa o modo monitor com um simples comando, mas normalmente as ferramentas usadas para capturas de pacote sem fio conseguem fazer ativar e desativar o modo para você. Você precisa estar perto o suficiente do AP e do cliente para receber um sinal, com isso você pode começar a capturar o tráfego direto na hora. Há vários utilitários de captura e monitoramento de conexões sem fio de código aberto, como o Aircrack-ng e o Kismet.

É importante dizer que, mesmo em uma rede sem fio criptografada, você pode capturar os pacotes, mas você poderá decodificar as cargas de tráfego sem saber a senha da rede sem fio.

## Wireshark e tcpdump

O Tcpdump é utilitário de linha de comando muito leve e usado para capturar e analisar pacotes. O Tcpdump usa a biblioteca de código aberto libpcap. Essa é uma biblioteca de captura de pacotes bem conhecida e usada em muitas ferramentas de captura de análise de pacotes. O Tcpdump também consegue gravar a captura de pacotes em um arquivo para análise, compartilhamento ou reprodução do tráfego depois. Além disso, ele consegue ler esses arquivos de captura de pacotes. A funcionalidade padrão do Tcpdump é fornecer uma breve análise de pacotes. Ele converte informações importantes a partir da camada 3 em formatos legíveis por humanos. Depois, ele exibe informações sobre cada pacote para dar destaque a elas ou apresenta diretamente no seu terminal. Faz executa tarefas como converter os endereços IP de origem e destino no formato de quatro pontos que já é comum para nós. E exibe o número das portas sendo usado pelas comunicações.

Vamos analisar rapidamente a saída de um exemplo do tcpdump.

O primeiro bit de informação é bastante simples. São a data e a hora de quando o pacote desta linha foi processado pelo kernel, no horário local. Depois, temos o protocolo da camada três identificado que, neste caso, é o IPv4. Depois disso, o quadrante da conexão é mostrado. Temos o endereço de origem, a porta de origem, o endereço de destino e a porta de destino.

Depois, as sinalizações TCP e o número de sequências TCP definidos no pacote, se houver.

`sudo tcpdump -i and host example.com`

Em seguida, temos o número de confirmação, o tamanho da janela TCP e as opções do TCP, se alguma tiver sido ativada. Por fim, temos o tamanho da carga em bytes. Lembre-se disso? Vimos algumas aulas atrás, quando falamos de redes. O Tcpdump permite realmente inspecionar esses valores dos pacotes diretamente. É importante ressaltar que o tcpdump, tentará resolver endereços de host em nomes de host por padrão. Além disso, ele vai substituir os números de porta pelos serviços normalmente associados que usam essas portas. Você pode anular esse comportamento com uma sinalização "-n".

Além disso, é possível ver os dados brutos reais que compõem o pacote. Eles são representados por dígitos hexadecimais com o uso da sinalização "-x" ou "X" maiúsculo, caso você queira o hexadecimal em interpretação ASCII dos dados.

Lembre-se que os pacotes são meros conjuntos de dados, ou grupos de uns e zeros. Eles representam informações dependendo dos valores desses dados e do ponto em que aparecem no fluxo de dados. Vamos relembrar dos cabeçalhos de pacote e como são estruturados e formatados. Com a visualização que o tcpdump nos dá, podemos ver os dados que se encaixam nos vários campos que compõem os cabeçalhos das camadas de um pacote.

O Wireshark é outra ferramenta de captura e análise de pacotes que você pode usar, mas é muito mais poderoso na análise de pacotes e aplicativos se comparado ao tcpdump. O Wireshark é um utilitário gráfico que também usa a biblioteca libpcap para capturar e interpretar os pacotes. Mas é muito mais extensível quando se trata de análise de protocolos e aplicativos.

Enquanto o tcpdump pode fazer análises básicas de alguns tipos de tráfego, como consultas e respostas DNS, o Wireshark pode fazer muito mais. O Wireshark pode decodificar cargas úteis criptografadas se conhecer a chave criptográfica. Ele pode identificar extrair cargas de dados de transferências de arquivos por meio de protocolos como SMB ou HTTP. O entendimento do Wireshark sobre os protocolos de nível de aplicativo ainda se estende às strings de filtro. Elas permitem aplicar regras de filtragem, como encontrar solicitações HTTP com strings específicas no URL, o que ficaria assim: "http.request.uri matches q=wireshark". Essa string de filtro consegue localizar pacotes na nossa captura que tem uma solicitação de URL que contém a string especificada. Neste caso, corresponderia a um parâmetro de consulta de um URL que busca "Wireshark". Embora seja possível fazer isso no tcpdump, é muito mais fácil no Wireshark.

A interface do Wireshark, que é dividida em três partes.
**A lista de pacotes está no topo, seguido da representação em camadas do pacote da lista selecionado. Por fim, a representação hexadecimal e ASCII do pacote selecionado ficam na parte inferior.**

A vista da lista de pacotes é classificada por cores para distinguir os diferentes tipos de tráfego da captura. O usuário pode configurar essa classificação por cor, o padrão é verde para pacotes TCP, azul claro para tráfego UDP e azul escuro para tráfego DNS. Além disso, preto identifica pacotes TCP problemáticos, como fora de ordem ou repetidos. Acima do painel da lista de pacotes, há uma caixa de filtro de exibição que oferece filtragem complexa dos pacotes a serem exibidos, o que é diferente dos filtros de captura, que seguem o padrão libpcap, assim como o tcpdump.

A profunda compreensão que o Wireshark tem dos protocolos permite o filtro por protocolo, além dos campos específicos disponíveis. Nelas, você verá uma série de protoclos entendidos pelo Wireshark. O Wireshark não só tem uma infiltração de gerenciamento de protocolos muito útil, mas também entende e pode acompanhar fluxos ou sessões tcp. Com isso, você consegue remontar o cenário rapidamente ver ambos os lados de uma sessão tcp, de forma a ver a troca de informações bidirecional entre as partes.

Outros recursos interessantes do Wireshark são sua capacidade de decodificar pacotes sem fio WPA e WEP criptografados se conhecer a senha de termos. Além disso, ele consegue monitorar o tráfego via Bluetooth com o hardware certo, além de tráfego USB e outros protocolos como o Zigbee. Ele ainda oferece extração e recuperação de arquivos, ou seja, extração de cargas de dados de arquivos transferidos por protocolos não criptografados, como transferências de arquivos HTTP, ou FTP. E tem mais: ele consegue extrair fluxos de áudio de tráfego VOIP não criptografado, enfim o Wireshark é espetacular.

### Sistemas de detecção/prevenção de invasão

Os sistemas IDS ou IPS monitoram e analisam o tráfego da rede. Então, o que os sistemas IDS e IPS fazem exatamente? Eles procuram comportamentos ou características que indiquem tráfego malicioso. A diferença entre um sistema IDS e um sistema IPS é que o IDS só faz a detecção, ele não adota medidas para bloquear ou impedir um ataque. Quando um ataque é detectado, o IDS só registra um alerta, mas o IPS pode ajustar regras de firewall em tempo real para bloquear ou eliminar o tráfego malicioso assim que o detectar. Os sistemas IDS e IPS podem ser de host ou de rede. No caso de um sistema de detecção de invasão de rede, ou NIDS, o sistema de detecção seria implantado em algum ponto da rede, e nesse ponto ele monitoraria o tráfego de um segmento da rede ou sub-rede.

Um sistema de detecção de invasão de host seria um software instalado no host para monitorar o tráfego de entrada e saída apenas desse host. Ele ainda pode monitorar eventuais alterações não autorizadas nos arquivos do sistema. Os sistemas NIDS são parecidos com os firewalls de várias maneiras. Mas o objetivo do firewall é evitar invasões com o bloqueio de tráfego potencialmente malicioso que vem de fora e impor ACLs entre redes. Os sistemas NIDS visa a detectar e alertar sobre possíveis atividades maliciosas provenientes da própria rede. Além disso, os firewalls só enxergam o tráfego entre as redes que foram configurados para proteger. Normalmente, eles não enxergariam tráfego entre máquinas da rede.

Portanto, o local do NIDS deve ser pensado com cautela na hora de instalar um sistema. Ele precisa ficar na topologia da rede de forma que tenha acesso ao tráfego que queremos monitorar. Uma boa maneira de obter acesso ao tráfego de rede é usar o recurso de espelhamento de portas, encontrado em muitos switches corporativos. Ele permite que todos os pacotes de uma porta, faixa de portas, ou VLAN inteira sejam espelhados para outra porta, a que o host NIDS se conectaria. Com essa configuração, nossa máquina NIDS seria capaz de ver todos os pacotes que entram e saem dos hosts no segmento do switch. Isso nos permite monitorar as comunicações entre máquinas e tráfego de hosts para redes externas, como a internet.

Os hosts NIDS analisariam esse tráfego ativando o modo promíscuo na porta de análise. Essa é a interface de rede conectada à porta espelhada do nosso switch, portanto, ela consegue ver todos os pacotes sendo passados e realizar uma análise do tráfego. Como essa interface é usada para receber pacotes espelhados da rede que queremos monitorar, um host NIDS deve ter pelo menos duas interfaces de rede. Uma para monitorar a análise e outra para se conectar à nossa rede para fins gerenciais e administrativos.

O posicionamento de um sistema NIP, ou de prevenção de invasões de rede, é diferente do de um sistema NIDS. Isso ocorre porque um sistema de prevenção é capaz de tomar medidas contra tráfego malicioso suspeito. Para que um dispositivo NIPS bloqueie ou elimine o tráfego de uma ameaça detectada, ele deve ser posicionado na linha do tráfego monitorado, ou seja, o tráfego monitorado deve passar pelo dispositivo NIPS. Se esse não fosse o caso, o host NIPS não seria capaz de atuar no tráfego suspeito.

Imagine: um dispositivo NIDS é um observador passivo que apenas assiste ao tráfego e envia um alerta se vir algo incomum, ao contrário de um dispositivo NIPS, que não só monitora o tráfego, mas também pode atuar no tráfego que está monitorando, geralmente bloqueando ou eliminando o tráfego. A detecção de ameaças ou tráfego malicioso normalmente é gerenciada por meio de detecção por assinatura, bem parecido com a forma de detectar malwares dos antivírus. Como especialista em suporte de TI, você pode ser responsável por administrar a configuração do IDS ou do IPS, o que envolve garantir que as regras e assinaturas estejam atualizadas. As assinaturas são características únicas do tráfego malicioso conhecido. Elas podem ser sequências específicas de pacotes ou pacotes com determinados valores codificados no campo de cabeçalho. Isso permite que os sistemas de detecção e prevenção de invasão reconheçam de forma rápida e simples quando há tráfego malicioso conhecido de fontes como botnets, worms e outros vetores comuns de ataque na internet. Mas, assim como os antivírus, ataques direcionados menos comuns podem não ser detectados por um sistema baseado em assinatura, já que pode não haver assinaturas desenvolvidas para esses casos. Então, também é possível criar regras personalizadas que representem os tipos de tráfego que podem ser considerados suspeitos, mas não necessariamente maliciosos. Isso permitiria que os investigadores avaliassem o tráfego em mais detalhes para determinar o potencial de dano. Se o tráfego é considerado malicioso, pode-se desenvolver uma assinatura a partir do tráfego e adicioná-la ao sistema. Mas o que acontece quando um sistema NIDS detecta algo malicioso? Essa parte pode ser configurada, mas normalmente o sistema NIDS registra o evento de detecção junto com uma captura completa de pacotes do tráfego malicioso. Um alerta também seria acionado para notificar a equipe de investigação de que há tráfego para se analisar. Dependendo da gravidade do evento, o alerta pode apenas enviar um e-mail de grupo criar um tíquete para acompanhar, ou pode ligar para alguém no meio da noite se for uma situação muito grave ou urgente. Esses alertas geralmente ainda têm informações de referência vinculadas a uma vulnerabilidade conhecida ou outras informações sobre a natureza do alerta para ajudar o investigador a analisar o evento.
