# Criptografia WEP e por que não usar

O primeiro protocolo de segurança lançado para redes Wi-Fi foi o **WEP, ou privacidade equivalente às redes com fio.** Ele fez parte do padrão 802.11 original, lançado em 1997. O objetivo do WEP era oferecer o mesmo nível de privacidade das redes com fio, isso significa que as informações repassadas à rede tinham que ser protegidas da espionagem de terceiros. Essa foi uma consideração importante para o desenvolvimento da especificação de redes sem fio.

Ao contrário das redes com fio, os pacotes poderiam ser interceptados por qualquer pessoa fisicamente próxima do ponto de acesso ou da estação do cliente. Sem algum tipo de criptografia para proteger os pacotes, o tráfego sem fio poderia ser lido por alguém próximo que quisesse ler. O WEP se mostrou muito ineficaz em fornecer confidencialidade ou segurança a redes sem fio. Em 2004, o WEP caiu rapidamente em desuso para dar lugar a sistemas mais seguros. **Ninguém deve usar o WEP mais. Nunca se sabe, você pode acabar encontrando sistemas muito desatualizados trabalhando com suporte de TI. Por isso, é importante entender por que o WEP é antiquado e quais são suas alternativas.**

Um conceito geral em segurança e criptografia é nunca enviar o texto simples e o texto cifrado juntos, impedindo que os invasores encontrem a chave usada para criptografia. Mas a verdadeira fraqueza do WEP não tem relação com os esquemas de autenticação, o uso que ele fazia da cifra de fluxo RC4 e a forma de usar os IVs para gerar chaves criptográfica levou à queda derradeira do WEP. O objetivo principal de um IV é introduzir mais elementos aleatórios na chave criptográfica para evitar sua reutilização. Quando se uma cifra de fluxo como a RC4, é muito importante que a chave criptográfica não seja reutilizada. Isso permitiria que um invasor comparasse duas mensagens criptografadas usando a mesma chave e conseguisse obter informações. Mas a chave criptográfica no WEP só tem a chave compartilhada, que não muda com muita frequência. Ela tinha 24 bits de dados aleatorizados, incluindo o IV adicionado à extremidade dela. Isso gera um pool de 24 bits de onde chaves criptográficas exclusivas são extraídas e usadas.

Você também pode dar uma olhada nas ferramentas de código aberto que demonstram o ataque em ação, como o Aircrack-ng ou o AirSnort. Eles conseguem obter uma chave WEP em questão de minutos, É meio assustador pensar nisso. Bom, agora você conhece os motivos técnicos da vulnerabilidade natural do WEP a ataques.

## Vamos enterrar o WEP para sempre! WPA/WPA2

O substituto do WEP, criado pela Wi-Fi Alliance, foi o WPA ou Wi-Fi de acesso protegido. O WPA foi lançado em 2003 como uma medida temporária enquanto a aliança finalizava sua especificação para o que viria a se tornar o WPA2, lançado em 2004. O WPA foi criado para ser um substituto de curto prazo que se tornaria compatível com hardwares mais antigos com suporte a WEP por meio uma simples atualização de firmware. Isso ajudou na adoção dos usuários porque não exigiu a compra de um novo equipamento Wi-Fi. Para resolver as deficiências de segurança do WEP, um novo protocolo de segurança foi lançado, o TKIP, ou protocolo de integridade de chave temporal.

O TKIP contou com três novos recursos que o tornaram mais seguro que o WEP.

Primeiro, um método de derivação de chaves mais seguro foi usado para incorporar o IV com segurança à chave criptográfica de cada pacote.
Segundo, um contador de sequências foi implementado para prevenir ataques de repetição com a rejeição de pacotes fora de ordem.
Terceiro, uma MIC, ou verificação de integridade de mensagens, de 64 bits foi adicionado para evitar falsificações, adulterações ou corrupção de pacotes.

O TKIP ainda usa a cifra RC4 como seu algoritmo de criptografia, mas resolveu as principais deficiências de geração de chaves do WEP com uma função de combinação de chaves, gerando chaves criptogáficas exclusivas para cada pacote. Ele também utiliza chaves longas, de 256 bits.

Esse recurso de combinação de chaves incorpora a famosa senha de vários termos do Wi-Fi ao IV. E isso é diferente da concatenação simplista entre chave compartilhada e IV. No WPA, a chave pré-compartilhada é a senha do Wi-Fi que você dá às pessoas quando elas querem usar sua rede sem fio. Ela não é usada diretamente para criptografar o tráfego. É usada como um fator de derivação da chave criptográfica. A senha é inserida no PBKDF2, ou função de derivação de chaves por senha 2, além do SSID das redes Wi-Fi, como um salt. Depois, isso passa pela função HMAC-SHA1 4.096 vezes para gerar uma chave criptográfica exclusiva. O SSID como salt é incorporado para ajudar na defesa contra ataques de tabela arco-íris. As 4.096 voltas no HMAC-SHA1 aumentam o poder computacional necessário para um ataque de força bruta.

Vale ressaltar que a chave pré-compartilhada pode ser digitada com dois métodos diferentes. Um valor hexadecimal de 64 caracteres pode ser inserido ou o valor de 64 caracteres é usado como senha, que é 64 caracteres hexadecimais vezes quatro bits, que dá 256 bits. A outra opção é usar a função PBKDF2, mas somente se você inserir caracteres ASCII como uma senha de termos. Se esse for o caso, a senha pode ter entre 8 e 63 caracteres.

O WPA2 aumenta ainda mais a segurança do WPA com a implementação do CCMP, ou protocolo CBC-MAC de modo contador. O WPA2 é a melhor segurança para redes sem fio disponível atualmente, por isso é muito importante que um especialista em suporte de TI conheça esse protocolo. ele trabalha com a cifra AES, finalmente se livrando dos problemas de segurança da cifra RC4. O processo de derivação de chave do WPA foi mantido e os requisitos para chaves pré-compartilhadas também. O contador com CBC-MAC é um modo especial de operação para cifras de bloco.

Ele permite a criptografia autenticada, ou seja, os dados são mantidos confidenciais e são autenticados. Isso acontece por meio de um mecanismo que autentica e depois criptografa. A saída do CBC-MAC é calculada primeiro. Depois, o código de autenticação gerado é criptografado junto com a mensagem por meio de uma cifra de bloco. Estamos usando o AES nesse caso, operando em modo de contador. Isso transforma uma cifra de bloco em uma cifra de fluxo com o uso um valor de semente aleatória aliado a um contador crescente para criar um fluxo de chaves que criptografa os dados.

Agora, vamos entender o processo de handshake de quatro vias que autentica clientes na rede. Vale destacar que, embora você possa não encontrar isso no dia a dia, é bom entender como o processo de autenticação funciona. Isso ajudará você a entender como o WPA2 pode ser violado. Este processo também gera a chave criptográfica temporária que será usada para criptografar dados desse cliente. Esse processo é chamado de handshake de quatro vias, já que é composto de quatro trocas de dados entre o cliente e o AP. Seu objetivo é permitir que um AP confirme que o cliente tem a chave-mestra em par correta, ou a chave pré-compartilhada em um cenário com WPA-PSK, sem revelar a PMK. A PMK é uma chave antiga que ainda pode ficar um bom tempo sem mudar. Assim, uma chave criptográfica é derivada do PMK usado para criptografar e descriptografar o tráfego entre um cliente e um AP. Essa chave é chamada de chave transitória em par, ou PTK. A PTK é gerada com o uso da PMK, do nonce AP, do nonce do cliente, do endereço MAC do AP e do endereço MAC do cliente. Todos esses elementos são concatenados e são submetidos a uma função. O nonce do AP e do cliente são apenas bits de dados aleatórios gerados por cada parte e que são trocados. O endereço MAC de cada elemento poderia ser identificado no cabeçalho dos pacotes, e as partes já devem ter a PMK correta. Com essa informação, a PTK pode ser gerada. Esse processo varia para cada cliente, para permitir a confidencialidade entre clientes. A PTK é, na verdade, composto de cinco chaves individuais, cada uma com sua finalidade. Duas chaves são usadas para criptografia e confirmação de pacotes EAPoL, e o protocolo de encapsulamento transporta essas mensagens. Duas chaves são usadas para enviar e receber códigos de integridade de mensagens. E, por fim, há uma chave temporal, usada para criptografar dados. O AP também transmite a GTK, ou chave transitória em grupo. Ela é criptografada com a chave criptográfica do EAPoL contida na PTK, que é usada para criptografar tráfego de difusão seletiva ou difusão convencional. Como esse tipo de tráfego costuma ser legível a todos os clientes conectados a um AP, essa GTK é compartilhada entre todos eles. Ela é atualizada e retransmitida periodicamente e quando um cliente se dissocia do AP.

Resumindo: As quatro mensagens trocadas em ordem são: o AP, que envia um nonce ao cliente; o cliente, que envia seu nonce ao AP; o AP, que envia a GTK, e o cliente responde com um Ack confirmando a negociação bem-sucedida. Os padrões WPA e WPA2 também contam com uma autenticação 802.1x para redes Wi-Fi. Esse método geralmente é chamado de WPA2-Enterprise. As configurações diferentes de 802.1x são chamadas de WPA2-Personal ou WPA2-PSK, já que usam uma chave pré-compartilhada para autenticar clientes. A única diferença é que, neste caso, o AP atua como o autenticador. O raio do back-end ainda é o servidor de autenticação, e a PMK é gerada por componentes do método EAP escolhido. Embora não seja exatamente um recurso de segurança, o WPS, ou configuração protegida para Wi-Fi, é um recurso prático criado para facilitar o processo de entrada em uma rede protegida WPA-PSK para os clientes.

Você consegue encontrar o WPS em uma lojinha de TI que usa roteadores SOHO comerciais. Nesses ambientes menores, pode ser útil facilitar a conexão segura de clientes sem fio às redes sem fio. Mas ativar esse recurso gera algumas impactos na segurança que você precisa conhecer. A Wi-Fi Alliance lançou o WPS em 2006. Ele oferece diversos métodos que permitem ao cliente sem fio se conectar com segurança a uma rede sem fio sem precisar inserir a chave pré-compartilhada diretamente. Isso facilita o uso de senhas muito longas e seguras sem complicar demais o processo. O WPS simplifica isso por permitir o compartilhamento seguro do SSID e da chave pré-compartilhada. Isso acontece depois da autenticação ou troca de dados realizada por um dos quatro métodos compatíveis.

O WPS suporta autenticação de entrada de PIN, NFC ou USB para troca dos detalhes da rede fora de banda ou autenticação por pressionamento de botão. Normalmente, é um botão pequeno que fica no roteador residencial com duas setas apontando no sentido anti-horário. O mecanismo de pressionamento de botão precisa que dois botões sejam pressionados: um do lado do AP e outro do lado do cliente. Isso exige proximidade física e um breve intervalo de tempo em que o cliente pode se autenticar pressionando um botão. Os métodos NFC e USB apenas oferecem um canal diferente para transmitir os dados para se conectar à rede. Os métodos PIN são realmente interessantes e também são onde a falha crítica apareceu.

O mecanismo de autenticação por PIN trabalha de dois modos.

Em um deles, o cliente gera um PIN para ser inserido no AP; no outro, o AP tem um PIN normalmente embutido no código do firmware para ser inserido no cliente.

O segundo modo é o vulnerável a um ataque de força bruta on-line.

O método de autenticação por PIN usa PINs de oito dígitos, mas o último dígito é uma soma de verificação calculada a partir dos primeiros sete. Isso faz com que o número total de PINs possíveis seja 10 elevado a 7ª potência, ou cerca de 10 milhões. Mas o PIN é autenticado pelo AP pela metade. Isso significa que o cliente envia os primeiros quatro dígitos ao AP, aguarda uma resposta positiva ou negativa, e, se a primeira metade estiver correta, envia a segunda.

Em resposta a isso, a Wi-Fi Alliance revisou os requisitos da especificação WPS, adicionando um período de bloqueio de um minuto após três tentativas incorretas de PIN. Essa medida aumentou o tempo máximo de adivinhação do PIN de quatro horas para menos de três dias. Esse cenário com certeza se encaixa no que um invasor determinado e paciente procura, mas a realidade é pior do que isso. Se sua rede for comprometida por esse ataque, como o PIN é um elemento imutável que faz parte da configuração do AP, o invasor pode reutilizar o PIN do WPS já obtido para chegar à nova senha. Isso aconteceria mesmo que você detectasse clientes sem fio não autorizados na sua rede e trocasse a senha do Wi-Fi.

O WPA2 é um protocolo de segurança muito robusto. Ele foi desenvolvido com os melhores mecanismos disponíveis para evitar ataques e garantir a confidencialidade dos dados sendo protegidos. Mesmo assim, é suscetível a algumas formas de ataque. Na verdade, o handshake de autenticação de quatro vias de que falamos antes pode receber um ataque de força bruta off-line. Se o invasor conseguir capturar o processo de handshake de quatro vias apenas para pacotes, pode começar a tentar adivinhar a chave pré-compartilhada ou a PMK. Ele pode obter os endereços MAC e os nonces dos pacotes de handshake de quatro vias e calcular as PTKs. Como se trata de código de autenticação de mensagens, chaves secretas se tornam parte da PTK. A adivinhação da PMK geraria um PTK que consegue validar um microfone. Esse é uma ataque de força bruta ou de dicionário, portanto depende da qualidade das adivinhações de senha. Esse método precisa de uma boa quantidade de poder de processamento para calcular a PMK a partir dos valores de SSID e de adivinhações de senha. Mas a maior parte dos requisitos de processamento está no cálculo da PMK. São necessárias 4.096 iterações de uma função hash, processo que pode ser extremamente acelerado por meio do uso de computação acelerada por GPU e recursos de computação em nuvem. Como a maior parte dos processamento envolve o cálculo da PMK ao aliar as adivinhações de senha aos SSIDs, é possível pré-calcular PMKs em massa para combinações de SSID e senha comuns. Isso reduz as exigências de processamento para derivar a PTK a partir dos elementos únicos da sessão. Esses conjuntos pré-calculados são chamados de tabelas arco-íris, e foi exatamente isso que foi feito. As tabelas arco-íris estão disponíveis para download para os 1.000 SSIDs mais usados e as 1 milhão de senhas mais comuns.

### Fortalecimento de redes sem fio

Em um mundo perfeito, todos nós estaríamos protegendo nossas redes sem fio usando 802.1X com EAP-TLS. Essa é, indiscutivelmente, a melhor segurança disponível, mas sempre com o gerenciamento adequado e seguro dos aspectos da PKI envolvidos. Mas essa opção também envolve muita complexidade e controle. Isso porque ela precisa de um **servidor radius e mais um back-end de autenticação, no mínimo.**

Com a implementação do EAP-TLS, todos os componentes da infraestrutura de chaves públicas também serão necessários. Isso adiciona ainda mais complexidade e pessoal para gerenciar. Você não só precisa implementar a PKI com segurança no back-end para gerenciar certificados, como também deve ter um sistema para assinar os certificados do cliente. Além disso, você terá que distribuí-los a cada cliente que se autenticasse na rede.

Normalmente, isso exige mais pessoal do que muitas empresas estão dispostas a contratar, porque há uma relação antagônica entre segurança e conveniência. Se o 802.1X é muito complexo para a empresa, a próxima melhor alternativa seria o **WPA2 com o modo AES/CCMP, mas para proteger contra ataques de força bruta ou tabela arco-íris, precisamos adotar algumas medidas para elevar o nível de processamento.**

Um termo longo e complexo que não fosse encontrado em dicionários aumenta o tempo e os recursos que um invasor teria que dispendiar para quebrar a senha. Atribuir um nome incomum e único ao SSID também tornaria os ataques de tabela arco-íris menos prováveis. Isso exigiria que um invasor calculasse por conta própria, o que eleva o tempo e os recursos necessários para o ataque. Quando se usa uma senha longa e complexa para o Wi-Fi, a tendência natural é querer usar WPS para conectar clientes à rede. Mas já vimos aqui que isso pode não ser uma boa ideia em termos de segurança.

Na prática, você não verá o WPS ativo em um ambiente corporativo porque essa é uma tecnologia voltada para o consumidor. Se sua empresa valoriza a segurança mais do que a conveniência, você precisa manter o WPS inativo nos APs. Verifique se esse recurso está mesmo desativado no painel de gerenciamento do AP. Também é uma boa ideia checar o estado do recurso usando uma ferramenta como o wash, que verifica e indica um componente que esteja com o WPS ativado. Essa verificação independente é bastante recomendada, já que alguns fabricantes de roteador não permitem desativar o WPS. Em alguns casos, desligar o recurso no painel de gerenciamento não o desativa realmente.
